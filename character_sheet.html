<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>Character Sheet: Fantasy + Survival (Online)</title>
<style>
  /* Theme Colors */
  :root {
    --bg-color: #2b1e12;
    --box-bg: #3b2918;
    --text-color: #f8e7c0;
    --border-color: #b8860b;
    --input-bg: #5a4228;
    --btn-hover: #7a5c38;
  }

  body { 
    background: var(--bg-color); 
    color: var(--text-color); 
    font-family: "Segoe UI", Tahoma, sans-serif; 
    padding: 20px; 
    max-width: 800px; 
    margin: 0 auto; 
  }
  
  /* Layout Boxes */
  .box { 
    border: 3px solid var(--border-color); 
    background: var(--box-bg); 
    padding: 15px; 
    border-radius: 12px; 
    margin-bottom: 20px; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
  }
  
  h2 { 
    margin-top: 0; 
    color: #ffd26a; 
    border-bottom: 1px solid #5a3d24; 
    padding-bottom: 8px; 
    margin-bottom: 15px; 
    font-size: 1.4rem; 
  }
  
  input, select, button { 
    background: var(--input-bg); 
    color: var(--text-color); 
    border: 2px solid var(--border-color); 
    padding: 6px; 
    border-radius: 6px; 
    margin: 4px 0; 
  }
  
  button { 
    cursor: pointer; 
    transition: background 0.2s; 
  }
  
  button:hover { 
    background: var(--btn-hover); 
  }
  
  /* Bars */
  .bar-container { 
    width: 100%; 
    background: #2b1e12; 
    height: 30px; 
    margin: 8px 0; 
    border-radius: 8px; 
    overflow: hidden; 
    border: 2px solid var(--border-color); 
  }
  
  .bar { 
    height: 100%; 
    text-align: center; 
    color: white; 
    font-weight: bold; 
    line-height: 30px; 
    transition: width 0.3s;
  }
  
  #hp-bar { background: #cc3333; }
  #water-bar { background: #0077b3; }
  #food-bar { background: #cc8800; }
  #sanity-bar { background: #5533cc; }
  #stress-bar { background: #880000; }

  .flex { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .full-width { width: 100%; }
  .paused { background-color: #f0ad4e !important; color: #2b1e12 !important; font-weight: bold; }
  .timer-text { font-family: monospace; font-size: 0.9rem; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

</head>
<body>

<div class="box" id="connection-box">
    <h2>üîó ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
    <div class="flex full-width">
        <label for="char-id">ID ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏Ñ‡∏£):</label>
        <input type="text" id="char-id" value="Player1" placeholder="‡πÄ‡∏ä‡πà‡∏ô: Arya, Bardic" style="flex-grow: 1;">
        <button onclick="connectCharacter()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    </div>
    <p id="status-message" style="color:#d1a056; margin-top:10px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ID ‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°"</p>
</div>


<div id="game-dashboard" style="display:none;">
    
    <div class="box">
        <h2>‚ù§Ô∏è HP (Health Points)</h2>
        <div class="bar-container"><div class="bar" id="hp-bar">0/200</div></div>
        <div class="flex">
            <input type="number" id="hp" value="200" style="width: 60px;"> / 
            <input type="number" id="maxhp" value="200" style="width: 60px;"> (Max HP)
        </div>
        
        <hr style="border-color:#5a3d24; margin:10px 0;">
        
        <div class="flex">
            <input type="number" id="hp_change" value="10" style="width: 80px;">
            <button onclick="adjustHP(1)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° HP</button>
            <button onclick="adjustHP(-1)">- ‡∏•‡∏î HP</button>
        </div>
    </div>
    
    <div class="box">
        <h2>‚è±Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ & Survival</h2>
        <button id="pause-btn" onclick="togglePause()" class="full-width">‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤</button>
        <p style="font-size:0.9em; color:#d1a056;">**‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ**</p>
    </div>
    
    <div class="box">
        <h2>üíß ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥ (3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</h2>
        <div class="bar-container"><div class="bar" id="water-bar">100% (03:00:00)</div></div>
        <p id="water-timer" class="timer-text" style="text-align:right;">03:00:00</p>
        <div class="flex">
            <input type="number" id="drink-amount" value="50" style="width: 80px;" min="0" max="100"> %
            <button onclick="refill('water')">üíß ‡∏î‡∏∑‡πà‡∏°/‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥</button>
        </div>
    </div>
    
    <div class="box">
        <h2>ü•ñ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</h2>
        <div class="bar-container"><div class="bar" id="food-bar">100% (03:00:00)</div></div>
        <p id="food-timer" class="timer-text" style="text-align:right;">03:00:00</p>
        <div class="flex">
            <input type="number" id="eat-amount" value="50" style="width: 80px;" min="0" max="100"> %
            <button onclick="refill('food')">ü•© ‡∏Å‡∏¥‡∏ô/‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
        </div>
    </div>

    <div class="box">
        <h2>üß† ‡∏™‡∏ï‡∏¥ (Sanity) ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î (Stress)</h2>
        
        <h3>‡∏™‡∏ï‡∏¥ (Sanity: 0-100)</h3>
        <div class="bar-container"><div class="bar" id="sanity-bar" style="width:100%;">100/100</div></div>
        <div class="flex">
            <input type="number" id="sanity-adj" value="5" style="width: 80px;">
            <button onclick="adjustSanity(1)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡∏¥</button>
            <button onclick="adjustSanity(-1)">- ‡∏•‡∏î‡∏™‡∏ï‡∏¥</button>
        </div>
        
        <h3 style="margin-top:20px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î (Stress: 0-200)</h3>
        <div class="bar-container"><div class="bar" id="stress-bar" style="width:0%;">0/200</div></div>
        <div class="flex">
            <input type="number" id="stress-adj" value="10" style="width: 80px;">
            <button onclick="adjustStress(1)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</button>
            <button onclick="adjustStress(-1)">- ‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</button>
        </div>
    </div>
    
    <div class="box">
        <h2>üé≤ ‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤</h2>
        <div class="flex">
            <input type="number" id="d_num" value="1" style="width: 50px;"> D 
            <input type="number" id="d_face" value="20" style="width: 60px;"> 
            <button onclick="rollDice('d')">‡∏ó‡∏≠‡∏¢‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤</button>
        </div>
        <p id="d_result" style="color:#ffd26a; font-weight:bold; margin-top:5px;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: -</p>
    </div>

</div>

<script>
// ==========================================================
// üö®üö® ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÇ‡∏Ñ‡πâ‡∏î Firebase Connection üö®üö®
// *‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏•‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ*
// ==========================================================
const firebaseConfig = {
    apiKey: "YOUR_API_KEY_HERE", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    projectId: "YOUR_PROJECT_ID", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "..."
};

let db;
let CHARACTER_ID = null;

function connectCharacter() {
    CHARACTER_ID = document.getElementById('char-id').value.trim();
    if (!CHARACTER_ID) {
        document.getElementById('status-message').textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ID ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£';
        return;
    }

    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(); 
        } else {
            // Already initialized
            db = firebase.firestore();
        }
        
        document.getElementById('status-message').textContent = `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à. ID: ${CHARACTER_ID}`;
        document.getElementById('connection-box').style.display = 'none';
        document.getElementById('game-dashboard').style.display = 'block';
        
        loadDataFromFirestore();
    } catch (e) {
        document.getElementById('status-message').textContent = `‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Config. Error: ${e.message}`;
    }
}


// ==========================================================
// ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: State & Time Loop (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Firebase)

// === STATE VARIABLES (Global) ===
let waterTime = 3 * 60 * 60; // 3 Hours in seconds (10800s)
let foodTime = 3 * 60 * 60;
let sanity = 100;
let stress = 0;
let isPaused = false;
let hasInitialized = false;

const MAX_TIME = 3 * 60 * 60; // 10800s

// === FIREBASE FUNCTIONS (Real-time Save/Load) ===
function saveDataToFirestore(reason = "manual") {
    if (!CHARACTER_ID || !db) return;
    
    const data = {
        id: CHARACTER_ID,
        hp: parseInt(document.getElementById('hp').value) || 0,
        maxhp: parseInt(document.getElementById('maxhp').value) || 200,
        waterTime: waterTime,
        foodTime: foodTime,
        sanity: sanity,
        stress: stress,
        isPaused: isPaused,
        lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
        // (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤ Stat ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ã‡∏ü‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
    };
    db.collection("characters").doc(CHARACTER_ID).set(data, { merge: true })
        .then(() => {
             // console.log("Data saved:", reason);
        })
        .catch((error) => { console.error("Error saving: ", error); });
}

function loadDataFromFirestore() {
    if (!CHARACTER_ID || !db) return;
    
    db.collection("characters").doc(CHARACTER_ID).onSnapshot((doc) => {
        if (doc.exists) {
            const data = doc.data();
            
            // Apply loaded data to local variables
            document.getElementById('hp').value = data.hp || 0;
            document.getElementById('maxhp').value = data.maxhp || 200;
            waterTime = data.waterTime;
            foodTime = data.foodTime;
            sanity = data.sanity;
            stress = data.stress;
            isPaused = data.isPaused;
            
            // Render UI
            updateBars();
            syncHP();
            togglePause(isPaused); // Update pause button state
        } else if (!hasInitialized) {
            // If no data and this is the first load, save default data to create the document
            saveDataToFirestore("initial"); 
            hasInitialized = true;
        }
    });
}

// === TIME & FORMATTING ===
function formatTime(seconds) {
  if (seconds < 0) seconds = 0;
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

// === MAIN LOOP (Every 1 Second) ===
setInterval(() => {
  if (!isPaused && CHARACTER_ID && db) {
    let shouldSave = false;
    
    // Check Water/Food status
    if (waterTime > 0) waterTime--;
    if (foodTime > 0) foodTime--;

    // Check for negative effects (e.g., HP loss)
    if (waterTime <= 0 || foodTime <= 0) {
        // Example: If starvation/dehydration, lose 1 HP every 10 seconds (for testing)
        if (waterTime % 10 === 0) {
            let currentHP = parseInt(document.getElementById('hp').value);
            document.getElementById('hp').value = Math.max(0, currentHP - 1);
            syncHP();
            shouldSave = true;
        }
    }

    updateBars();
    
    // Save data every 60 seconds (or if HP changed)
    if (waterTime % 60 === 0 || shouldSave) {
         saveDataToFirestore("autosave");
    }
  }
}, 1000);

// === CONTROLS MODIFIED TO SAVE DATA ===
function updateBars() {
  // Water
  let waterPct = (waterTime / MAX_TIME) * 100;
  document.getElementById('water-bar').style.width = waterPct + "%";
  document.getElementById('water-bar').textContent = Math.round(waterPct) + "%";
  document.getElementById('water-timer').textContent = formatTime(waterTime);

  // Food
  let foodPct = (foodTime / MAX_TIME) * 100;
  document.getElementById('food-bar').style.width = foodPct + "%";
  document.getElementById('food-bar').textContent = Math.round(foodPct) + "%";
  document.getElementById('food-timer').textContent = formatTime(foodTime);
  
  // Sanity/Stress
  const sbar = document.getElementById('sanity-bar');
  sbar.style.width = sanity + "%";
  sbar.textContent = sanity + "/100";
  
  const tbar = document.getElementById('stress-bar');
  tbar.style.width = (stress / 2) + "%";
  tbar.textContent = stress + "/200";
  
  // Also syncs HP bar
  syncHP(); 
}


function togglePause(externalState) {
  const btn = document.getElementById('pause-btn');

  // If called without arguments, it means the user clicked the button
  if (externalState === undefined) {
    isPaused = !isPaused;
    saveDataToFirestore("pause_toggle"); 
  } else {
    // If called with arguments, it's updating from the database
    isPaused = externalState; 
  }
  
  if (isPaused) {
    btn.textContent = "‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤";
    btn.classList.add("paused");
  } else {
    btn.textContent = "‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤";
    btn.classList.remove("paused");
  }
}

function adjustHP(direction) {
  const change = parseInt(document.getElementById('hp_change').value) || 0;
  const hpInput = document.getElementById('hp');
  const maxInput = document.getElementById('maxhp');
  
  let currentVal = parseInt(hpInput.value);
  let maxVal = parseInt(maxInput.value);
  
  if(direction > 0) {
    currentVal += change;
  } else {
    currentVal -= change;
  }

  if (currentVal < 0) currentVal = 0;
  if (currentVal > maxVal) currentVal = maxVal;
  
  hpInput.value = currentVal;
  syncHP();
  saveDataToFirestore("hp_adjust"); // <-- SAVES DATA
}

function syncHP() {
  const hpInput = document.getElementById('hp');
  const maxInput = document.getElementById('maxhp');
  const bar = document.getElementById('hp-bar');
  
  let val = parseInt(hpInput.value);
  let max = parseInt(maxInput.value);
  
  let pct = (val / max) * 100;
  if (pct < 0) pct = 0; if (pct > 100) pct = 100;
  
  bar.style.width = pct + "%";
  bar.textContent = `${val}/${max}`;
}

function refill(type) {
  let amountPct = 0;
  if (type === 'water') amountPct = parseInt(document.getElementById('drink-amount').value) || 0;
  if (type === 'food') amountPct = parseInt(document.getElementById('eat-amount').value) || 0;

  let secondsToAdd = (amountPct / 100) * MAX_TIME;

  if (type === 'water') {
    waterTime = Math.min(MAX_TIME, waterTime + secondsToAdd);
  } else {
    foodTime = Math.min(MAX_TIME, foodTime + secondsToAdd);
  }
  updateBars();
  saveDataToFirestore(type + "_refill"); // <-- SAVES DATA
}

function adjustSanity(dir) {
  const amount = parseInt(document.getElementById('sanity-adj').value) || 0;
  sanity += (amount * dir);
  if (sanity < 0) sanity = 0;
  if (sanity > 100) sanity = 100;
  
  updateBars();
  saveDataToFirestore("sanity_adjust"); // <-- SAVES DATA
}

function adjustStress(dir) {
  const amount = parseInt(document.getElementById('stress-adj').value) || 0;
  stress += (amount * dir);
  if (stress < 0) stress = 0;
  if (stress > 200) stress = 200;
  
  updateBars();
  saveDataToFirestore("stress_adjust"); // <-- SAVES DATA
}

function rollDice(type) {
  const face = parseInt(document.getElementById(type+'_face').value);
  const num = parseInt(document.getElementById(type+'_num').value);
  let total = 0;
  let rolls = [];
  
  for(let i=0; i<num; i++) {
    let r = Math.floor(Math.random() * face) + 1;
    rolls.push(r);
    total += r;
  }
  
  document.getElementById(type+'_result').textContent = `${total} (${rolls.join(', ')})`;
}

// Event Listeners for direct input changes (HP/MaxHP)
document.getElementById('hp').addEventListener('change', () => saveDataToFirestore("hp_manual"));
document.getElementById('maxhp').addEventListener('change', () => saveDataToFirestore("maxhp_manual"));

</script>
</body>
</html>