<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>Character Sheet: Fantasy + Survival (Online)</title>
<style>
  /* Theme Colors */
  :root {
    --bg-color: #2b1e12;
    --box-bg: #3b2918;
    --text-color: #f8e7c0;
    --border-color: #b8860b;
    --input-bg: #5a4228;
    --btn-hover: #7a5c38;
  }

  body { background: var(--bg-color); color: var(--text-color); font-family: "Segoe UI", Tahoma, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
  
  /* Layout Boxes */
  .box { border: 3px solid var(--border-color); background: var(--box-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
  
  h2 { margin-top: 0; color: #ffd26a; border-bottom: 1px solid #5a3d24; padding-bottom: 8px; margin-bottom: 15px; font-size: 1.4rem; }
  h3 { margin: 10px 0 5px 0; color: #e0c090; font-size: 1.1rem; }

  /* Inputs & Buttons */
  input, select, button, textarea { background: var(--input-bg); color: #ffe7b3; border: 1px solid var(--border-color); padding: 5px; border-radius: 6px; font-size: 1rem; }
  button { cursor: pointer; font-weight: bold; transition: background 0.2s; }
  button:hover { background: var(--btn-hover); filter: brightness(1.1); }
  button:active { transform: translateY(1px); }

  .flex { display: flex; gap: 10px; flex-wrap: wrap; }
  .statbox { width: 80px; text-align: center; background: #2b1e12; padding: 8px; border-radius: 8px; border: 1px solid #5a3d24; }
  .statbox input { width: 90%; text-align: center; }

  /* Bars System */
  .bar-wrapper { margin-bottom: 15px; }
  .bar-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px; }
  .timer-text { font-family: monospace; font-size: 1.1rem; color: #ffd26a; font-weight: bold; }
  
  .bar-container { width: 100%; background: #1a120b; height: 24px; border-radius: 12px; overflow: hidden; border: 2px solid #5a3d24; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.6); }
  .bar { height: 100%; text-align: center; color: white; font-weight: bold; line-height: 24px; text-shadow: 1px 1px 2px black; font-size: 0.9rem; transition: width 0.3s linear; }

  /* Specific Bar Colors */
  #hp-bar { background: linear-gradient(90deg, #cc3333, #ff6666); }
  #water-bar { background: linear-gradient(90deg, #0077b3, #00aaff); }
  #food-bar { background: linear-gradient(90deg, #cc8800, #ffaa00); }
  #sanity-bar { background: linear-gradient(90deg, #5533cc, #7a5cff); }
  #stress-bar { background: linear-gradient(90deg, #880000, #aa3333); }

  /* Control Buttons Colors */
  .btn-heal { background: #cc3333; color: white; border-color: #ff6666; }
  .btn-water { background: #0077b3; color: white; border-color: #00aaff; }
  .btn-food { background: #cc8800; color: white; border-color: #ffaa00; }
  .btn-sanity { background: #5533cc; color: white; border-color: #7a5cff; }
  .btn-stress { background: #880000; color: white; border-color: #aa3333; }
  .btn-pause { background: #666; color: white; width: 120px; }
  .btn-pause.paused { background: #28a745; border-color: #4cd16e; } /* Green when ready to resume */

  .controls { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
  .small-text { font-size: 0.8rem; color: #aaa; margin-left: 5px; }

  /* Dice & Stress Calc */
  .dice-section { background: #2b1e12; padding: 10px; border-radius: 8px; margin-top: 10px; }
  .result-span { color: #ffd26a; font-weight: bold; margin-left: 5px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

</head>
<body>

<div class="box" id="connection-box">
    <h2>üîó ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
    <div class="flex" style="width: 100%; align-items: center;">
        <label for="char-id" style="min-width: 150px;">ID ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏Ñ‡∏£):</label>
        <input type="text" id="char-id" value="Player1" placeholder="‡πÄ‡∏ä‡πà‡∏ô: Arya, Bardic" style="flex-grow: 1;">
        <button onclick="connectCharacter()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    </div>
    <p id="status-message" style="color:#d1a056; margin-top:10px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ID ‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°"</p>
</div>

<div id="game-dashboard" style="display:none;">

<div class="box">
  <h2>‚ù§Ô∏è ‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (HP)</h2>
  <div class="bar-container">
    <div id="hp-bar" class="bar" style="width: 100%;">200/200</div>
  </div>
  <div class="controls" style="margin-top: 10px; justify-content: center;">
    <label>HP:</label> <input id="hp" type="number" value="200" style="width:60px;">
    <label>/</label> <input id="maxhp" type="number" value="200" style="width:60px;">
    <span style="width:20px;"></span>
    <input id="hp_change" type="number" placeholder="+/-" value="10" style="width:60px;">
    <button class="btn-heal" onclick="adjustHP()">‡∏õ‡∏£‡∏±‡∏ö HP</button>
  </div>
</div>

<div class="box">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h2 style="margin:0; border:none;">‚è≥ ‡∏Å‡∏≤‡∏£‡∏¢‡∏±‡∏á‡∏ä‡∏µ‡∏û (3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</h2>
    <button id="pause-btn" class="btn-pause" onclick="togglePause()">‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤</button>
  </div>
  <hr style="border-color:#5a3d24; margin-bottom:15px;">

  <div class="bar-wrapper">
    <div class="bar-header">
      <span>üíß ‡∏ô‡πâ‡∏≥ (Water)</span>
      <span id="water-timer" class="timer-text">03:00:00</span>
    </div>
    <div class="bar-container">
      <div id="water-bar" class="bar" style="width: 100%;">100%</div>
    </div>
    <div class="controls">
      <input type="number" id="drink-amount" value="20" style="width:50px;"> %
      <button class="btn-water" onclick="refill('water')">‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥</button>
      <span class="small-text">(‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° HP)</span>
    </div>
  </div>

  <div class="bar-wrapper">
    <div class="bar-header">
      <span>üçó ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Food)</span>
      <span id="food-timer" class="timer-text">03:00:00</span>
    </div>
    <div class="bar-container">
      <div id="food-bar" class="bar" style="width: 100%;">100%</div>
    </div>
    <div class="controls">
      <input type="number" id="eat-amount" value="20" style="width:50px;"> %
      <button class="btn-food" onclick="refill('food')">‡∏Å‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
      <span class="small-text">(‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° HP)</span>
    </div>
  </div>
</div>

<div class="box">
  <h2>üß† ‡∏™‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡πÉ‡∏à</h2>
  
  <div class="bar-wrapper">
    <div class="bar-header"><span>üîÆ ‡∏™‡∏ï‡∏¥ (Sanity)</span></div>
    <div class="bar-container">
      <div id="sanity-bar" class="bar" style="width: 100%;">100/100</div>
    </div>
    <div class="controls">
      <input type="number" id="sanity-adj" value="10" style="width:50px;">
      <button class="btn-sanity" onclick="adjustSanity(1)">+ ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π</button>
      <button style="background:#444; color:white;" onclick="adjustSanity(-1)">- ‡∏•‡∏î‡∏™‡∏ï‡∏¥</button>
    </div>
  </div>

  <div class="bar-wrapper">
    <div class="bar-header"><span>üí¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î (Stress - Max 200)</span></div>
    <div class="bar-container">
      <div id="stress-bar" class="bar" style="width: 0%;">0/200</div>
    </div>
    <div class="controls">
      <input type="number" id="stress-adj" value="10" style="width:50px;">
      <button class="btn-stress" onclick="adjustStress(1)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</button>
      <button style="background:#444; color:white;" onclick="adjustStress(-1)">- ‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</button>
    </div>

    <div class="dice-section">
      <strong>üé≤ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏ö‡πÄ‡∏ï‡πã‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</strong><br>
      <div style="margin-top:5px; display:flex; align-items:center; gap:10px;">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤: <input type="number" id="dice-count-calc" value="3" style="width:40px;">
        <button onclick="calcStressPenalty()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
        <span id="stress-penalty-result" class="result-span">‡∏ú‡∏•‡∏•‡∏ö: 0</span>
      </div>
      <div class="small-text" style="margin-top:4px;">(‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏Å 10 ‡πÅ‡∏ï‡πâ‡∏° ‡∏•‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤ | ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡∏¥‡∏ô 150 ‡∏•‡∏ö 30 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</div>
    </div>
  </div>
</div>

<div class="box">
  <h2>‚öîÔ∏è ‡∏™‡πÄ‡∏ï‡∏ï‡∏±‡∏™ & ‡∏Å‡∏≤‡∏£‡∏ó‡∏≠‡∏¢‡πÄ‡∏ï‡πã‡∏≤</h2>
  
  <div class="flex" style="justify-content: center; margin-bottom: 20px;">
    <div class="statbox">STR<br><input type="number" value="0" id="stat-str"></div>
    <div class="statbox">DEX<br><input type="number" value="0" id="stat-dex"></div>
    <div class="statbox">CON<br><input type="number" value="0" id="stat-con"></div>
    <div class="statbox">INT<br><input type="number" value="0" id="stat-int"></div>
    <div class="statbox">WIS<br><input type="number" value="0" id="stat-wis"></div>
    <div class="statbox">CHA<br><input type="number" value="0" id="stat-cha"></div>
  </div>

  <div class="dice-section">
    <div class="controls">
      <span style="width:30px; font-weight:bold;">PD:</span>
      <input id="pd_face" type="number" value="6" style="width:40px;" title="‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡πã‡∏≤"> x 
      <input id="pd_num" type="number" value="1" style="width:40px;" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"> 
      <button onclick="rollDice('pd')">‡∏ó‡∏≠‡∏¢</button>
      <span id="pd_result" class="result-span">-</span>
    </div>
    <div class="controls">
      <span style="width:30px; font-weight:bold;">MD:</span>
      <input id="md_face" type="number" value="6" style="width:40px;"> x 
      <input id="md_num" type="number" value="1" style="width:40px;"> 
      <button onclick="rollDice('md')">‡∏ó‡∏≠‡∏¢</button>
      <span id="md_result" class="result-span">-</span>
    </div>
    <div class="controls">
      <span style="width:30px; font-weight:bold;">ND:</span>
      <input id="nd_face" type="number" value="6" style="width:40px;"> x 
      <input id="nd_num" type="number" value="1" style="width:40px;"> 
      <button onclick="rollDice('nd')">‡∏ó‡∏≠‡∏¢</button>
      <span id="nd_result" class="result-span">-</span>
    </div>
  </div>
</div>

<div class="box">
  <h2>üí∞ ‡∏Ç‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡∏ß & ‡πÄ‡∏á‡∏¥‡∏ô</h2>
  ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç: <input type="number" value="0" style="width:80px;" id="money">
  <br><br>
  <textarea style="width:98%; height:80px;" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏Å‡∏¥‡∏•..." id="inventory"></textarea>
</div>

</div> <script>
// ==========================================================
// üö®üö® ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÇ‡∏Ñ‡πâ‡∏î Firebase Connection üö®üö®
// *‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏•‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ*
// ==========================================================
const firebaseConfig = {
    apiKey: "YOUR_API_KEY_HERE", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    projectId: "YOUR_PROJECT_ID", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "..."
};

let db;
let CHARACTER_ID = null;
let hasInitialized = false;

function connectCharacter() {
    CHARACTER_ID = document.getElementById('char-id').value.trim();
    if (!CHARACTER_ID) {
        document.getElementById('status-message').textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà ID ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£';
        return;
    }

    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(); 
        } else {
            db = firebase.firestore();
        }
        
        document.getElementById('status-message').textContent = `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à. ID: ${CHARACTER_ID}`;
        document.getElementById('connection-box').style.display = 'none';
        document.getElementById('game-dashboard').style.display = 'block';
        
        loadDataFromFirestore();
    } catch (e) {
        document.getElementById('status-message').textContent = `‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Config. Error: ${e.message}`;
    }
}

// === FIREBASE FUNCTIONS (Real-time Save/Load) ===
function getCharacterData() {
    return {
        id: CHARACTER_ID,
        // HP & Survival
        hp: parseInt(document.getElementById('hp').value) || 0,
        maxhp: parseInt(document.getElementById('maxhp').value) || 200,
        waterTime: waterTime,
        foodTime: foodTime,
        isPaused: isPaused,
        // Mental Status
        sanity: sanity,
        stress: stress,
        // Stats & Inventory (Optional, but good practice to sync)
        stats: {
            str: parseInt(document.getElementById('stat-str').value) || 0,
            dex: parseInt(document.getElementById('stat-dex').value) || 0,
            con: parseInt(document.getElementById('stat-con').value) || 0,
            int: parseInt(document.getElementById('stat-int').value) || 0,
            wis: parseInt(document.getElementById('stat-wis').value) || 0,
            cha: parseInt(document.getElementById('stat-cha').value) || 0,
        },
        money: parseInt(document.getElementById('money').value) || 0,
        inventory: document.getElementById('inventory').value,
        
        lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
    };
}

function saveDataToFirestore(reason = "manual") {
    if (!CHARACTER_ID || !db) return;
    
    const data = getCharacterData();

    db.collection("characters").doc(CHARACTER_ID).set(data, { merge: true })
        .then(() => {
             // console.log("Data saved:", reason);
        })
        .catch((error) => { console.error("Error saving: ", error); });
}

function loadDataFromFirestore() {
    if (!CHARACTER_ID || !db) return;
    
    // Listen for real-time changes
    db.collection("characters").doc(CHARACTER_ID).onSnapshot((doc) => {
        if (doc.exists) {
            const data = doc.data();
            
            // Apply loaded data to local variables & UI
            document.getElementById('hp').value = data.hp ?? 200;
            document.getElementById('maxhp').value = data.maxhp ?? 200;
            waterTime = data.waterTime ?? MAX_TIME;
            foodTime = data.foodTime ?? MAX_TIME;
            sanity = data.sanity ?? 100;
            stress = data.stress ?? 0;
            isPaused = data.isPaused ?? false;
            
            // Load Stats & Inventory
            if(data.stats) {
                document.getElementById('stat-str').value = data.stats.str ?? 0;
                document.getElementById('stat-dex').value = data.stats.dex ?? 0;
                document.getElementById('stat-con').value = data.stats.con ?? 0;
                document.getElementById('stat-int').value = data.stats.int ?? 0;
                document.getElementById('stat-wis').value = data.stats.wis ?? 0;
                document.getElementById('stat-cha').value = data.stats.cha ?? 0;
            }
            document.getElementById('money').value = data.money ?? 0;
            document.getElementById('inventory').value = data.inventory ?? '';

            // Render UI
            updateBars(false); // Update bars without saving
            syncHP(false);
            togglePause(isPaused, false); // Update pause button state without saving
            
        } else if (!hasInitialized) {
            // If no data exists, create the document with default values and local state
            saveDataToFirestore("initial_create"); 
            hasInitialized = true;
        }
    });
}


// ==========================================================
// ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÇ‡∏Ñ‡πâ‡∏î Logic ‡πÄ‡∏î‡∏¥‡∏° (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Firebase)
// ==========================================================

// === CONFIGURATION ===
const MAX_TIME = 3 * 60 * 60; // 3 Hours in seconds (10800s)

// === STATE VARIABLES ===
let waterTime = MAX_TIME;
let foodTime = MAX_TIME;
let sanity = 100;
let stress = 0;
let isPaused = false;


// === TIME & FORMATTING ===
function formatTime(seconds) {
  if (seconds < 0) seconds = 0;
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

// === MAIN LOOP (Every 1 Second) ===
setInterval(() => {
  if (!isPaused && CHARACTER_ID && db) {
    let shouldSave = false;
    
    if (waterTime > 0) waterTime--;
    if (foodTime > 0) foodTime--;

    // Example: HP loss when survival timer hits 0
    if (waterTime <= 0 || foodTime <= 0) {
        if (waterTime % 10 === 0) { 
            let currentHP = parseInt(document.getElementById('hp').value);
            document.getElementById('hp').value = Math.max(0, currentHP - 1);
            syncHP(true); // Save HP loss
            shouldSave = true;
        }
    }

    updateBars(false);

    // Auto-save every 60 seconds
    if (waterTime % 60 === 0 || foodTime % 60 === 0 || shouldSave) {
         saveDataToFirestore("autosave");
    }
  }
}, 1000);

function updateBars(shouldSave = true) {
  // Water
  let waterPct = (waterTime / MAX_TIME) * 100;
  document.getElementById('water-bar').style.width = waterPct + "%";
  document.getElementById('water-bar').textContent = Math.round(waterPct) + "%";
  document.getElementById('water-timer').textContent = formatTime(waterTime);

  // Food
  let foodPct = (foodTime / MAX_TIME) * 100;
  document.getElementById('food-bar').style.width = foodPct + "%";
  document.getElementById('food-bar').textContent = Math.round(foodPct) + "%";
  document.getElementById('food-timer').textContent = formatTime(foodTime);

  // Sanity/Stress
  const sbar = document.getElementById('sanity-bar');
  sbar.style.width = sanity + "%";
  sbar.textContent = sanity + "/100";
  
  const tbar = document.getElementById('stress-bar');
  tbar.style.width = (stress / 2) + "%"; // Scale 200 to 100%
  tbar.textContent = stress + "/200";

  if (shouldSave) saveDataToFirestore("ui_update");
}

// === CONTROLS ===
function togglePause(externalState, shouldSave = true) {
  const btn = document.getElementById('pause-btn');
  
  // Logic to handle user click (externalState is undefined) vs. DB load
  if (externalState === undefined) {
      isPaused = !isPaused;
  } else {
      isPaused = externalState;
  }

  if (isPaused) {
    btn.textContent = "‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤";
    btn.classList.add("paused");
  } else {
    btn.textContent = "‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤";
    btn.classList.remove("paused");
  }

  if (shouldSave) saveDataToFirestore("pause_toggle");
}

function refill(type) {
  // Convert input % to seconds
  let amountPct = 0;
  if (type === 'water') amountPct = parseInt(document.getElementById('drink-amount').value) || 0;
  if (type === 'food') amountPct = parseInt(document.getElementById('eat-amount').value) || 0;

  let secondsToAdd = (amountPct / 100) * MAX_TIME;

  if (type === 'water') {
    waterTime = Math.min(MAX_TIME, waterTime + secondsToAdd);
  } else {
    foodTime = Math.min(MAX_TIME, foodTime + secondsToAdd);
  }
  updateBars(true); // Save after refill
}

// === HP SYSTEM ===
function adjustHP() {
  const change = parseInt(document.getElementById('hp_change').value) || 0;
  const hpInput = document.getElementById('hp');
  const maxInput = document.getElementById('maxhp');
  
  let currentVal = parseInt(hpInput.value);
  let maxVal = parseInt(maxInput.value);
  
  currentVal += change;
  if (currentVal < 0) currentVal = 0;
  if (currentVal > maxVal) currentVal = maxVal;
  
  hpInput.value = currentVal;
  syncHP(true); // Save after manual adjust
}

function syncHP(shouldSave = true) {
  const hpInput = document.getElementById('hp');
  const maxInput = document.getElementById('maxhp');
  const bar = document.getElementById('hp-bar');
  
  let val = parseInt(hpInput.value);
  let max = parseInt(maxInput.value);
  
  let pct = (val / max) * 100;
  if (pct < 0) pct = 0; if (pct > 100) pct = 100;
  
  bar.style.width = pct + "%";
  bar.textContent = `${val}/${max}`;

  if (shouldSave) saveDataToFirestore("hp_sync");
}

// Manual inputs listener (HP and MaxHP)
document.getElementById('hp').addEventListener('input', () => syncHP(true));
document.getElementById('maxhp').addEventListener('input', () => syncHP(true));

// Manual inputs listener (Stats and Inventory)
document.getElementById('stat-str').addEventListener('change', () => saveDataToFirestore("stat_update"));
document.getElementById('stat-dex').addEventListener('change', () => saveDataToFirestore("stat_update"));
document.getElementById('stat-con').addEventListener('change', () => saveDataToFirestore("stat_update"));
document.getElementById('stat-int').addEventListener('change', () => saveDataToFirestore("stat_update"));
document.getElementById('stat-wis').addEventListener('change', () => saveDataToFirestore("stat_update"));
document.getElementById('stat-cha').addEventListener('change', () => saveDataToFirestore("stat_update"));
document.getElementById('money').addEventListener('change', () => saveDataToFirestore("money_update"));
document.getElementById('inventory').addEventListener('change', () => saveDataToFirestore("inventory_update"));


// === SANITY & STRESS ===
function adjustSanity(dir) {
  const amount = parseInt(document.getElementById('sanity-adj').value) || 0;
  sanity += (amount * dir);
  if (sanity < 0) sanity = 0;
  if (sanity > 100) sanity = 100;
  
  updateBars(true); // Save after adjust
}

function adjustStress(dir) {
  const amount = parseInt(document.getElementById('stress-adj').value) || 0;
  stress += (amount * dir);
  if (stress < 0) stress = 0;
  if (stress > 200) stress = 200;
  
  updateBars(true); // Save after adjust
}

function calcStressPenalty() {
  const diceCount = parseInt(document.getElementById('dice-count-calc').value) || 3;
  let penalty = 0;
  
  if (stress >= 150) {
    penalty = -30;
  } else {
    // Every 10 stress = -1 * diceCount
    penalty = -(Math.floor(stress / 10) * diceCount);
  }
  
  const res = document.getElementById('stress-penalty-result');
  res.textContent = `‡∏ú‡∏•‡∏•‡∏ö: ${penalty}`;
  res.style.color = penalty < 0 ? '#ff4444' : '#ffd26a';
}

// === DICE ROLLER ===
function rollDice(type) {
  const face = parseInt(document.getElementById(type+'_face').value);
  const num = parseInt(document.getElementById(type+'_num').value);
  let total = 0;
  let rolls = [];
  
  for(let i=0; i<num; i++) {
    let r = Math.floor(Math.random() * face) + 1;
    rolls.push(r);
    total += r;
  }
  
  document.getElementById(type+'_result').textContent = `${total} (${rolls.join(', ')})`;
}

// Initial sync for local state (will be overwritten by Firestore on connect)
syncHP(false);
updateBars(false);
</script>

</body>
</html>