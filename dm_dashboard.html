<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>DM Real-time Dashboard (Online Monitor)</title>
<style>
    body { background: #1f1f1f; color: #e0e0e0; font-family: "Segoe UI", Tahoma, sans-serif; padding: 20px; }
    h1 { color: #f0ad4e; border-bottom: 2px solid #5a3d24; padding-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #444; padding: 10px; text-align: left; }
    th { background: #333; color: #fff; }
    tr:nth-child(even) { background-color: #2a2a2a; }
    tr:hover { background-color: #3b3b3b; }
    .status-text { font-weight: bold; }
    .hp-bar-container { height: 15px; background: #666; border-radius: 4px; overflow: hidden; }
    .hp-fill { height: 100%; background: #cc3333; transition: width 0.3s; }
    .water-fill { background: #0077b3; }
    .food-fill { background: #cc8800; }
    .sanity-fill { background: #5533cc; }
    .stress-fill { background: #880000; }
    .paused { color: #f0ad4e; font-style: italic; font-weight: bold;}
    .running { color: #28a745; font-weight: bold;}
    .status-area { margin-bottom: 15px; font-size: 0.9em; color: #aaa; }
    .timer-text { font-family: monospace; font-size: 0.9rem; }
    td, th { text-align: center; }
    td:first-child { text-align: left; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

<h1>üëÅÔ∏è‚Äçüó®Ô∏è DM Real-time Dashboard</h1>
<div id="status" class="status-area">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<table>
    <thead>
        <tr>
            <th>ID ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</th>
            <th>HP</th>
            <th>‡∏ô‡πâ‡∏≥</th>
            <th>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
            <th>‡∏™‡∏ï‡∏¥</th>
            <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
        </tr>
    </thead>
    <tbody id="dashboard-body">
        <tr><td colspan="7" style="text-align:center;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
    </tbody>
</table>

<script>
// ==========================================================
// üö®üö® ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÇ‡∏Ñ‡πâ‡∏î Firebase Connection üö®üö®
// *‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏•‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ*
// ==========================================================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY_HERE", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  projectId: "YOUR_PROJECT_ID", // <-- üîë ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
};

// Initialize Firebase & Firestore
try {
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    document.getElementById('status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
    setupDMListener(db);
} catch (e) {
    document.getElementById('status').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Config.';
}

const MAX_TIME = 3 * 60 * 60; // 10800 seconds

/**
 * Formats time from seconds to HH:MM:SS
 */
function formatTime(seconds) {
  if (seconds < 0) seconds = 0;
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

/**
 * Renders a progress bar based on current/max value.
 */
function renderBar(current, max, colorClass) {
    const percent = Math.max(0, Math.min(100, (current / max) * 100));
    return `
        <div class="hp-bar-container">
            <div class="hp-fill ${colorClass}" style="width:${percent}%"></div>
        </div>
        ${current}/${max} (${Math.round(percent)}%)
    `;
}

/**
 * Main listener function for DM Dashboard.
 * It listens to the entire 'characters' collection.
 */
function setupDMListener(db) {
    const dashboardBody = document.getElementById('dashboard-body');
    
    // Listen to all changes in the 'characters' collection
    db.collection("characters").onSnapshot((querySnapshot) => {
        let html = '';
        
        querySnapshot.forEach((doc) => {
            const id = doc.id;
            const data = doc.data();
            
            // Default values and check for existence
            const hp = data.hp ?? 0;
            const maxhp = data.maxhp ?? 200;
            const waterTime = data.waterTime ?? 0;
            const foodTime = data.foodTime ?? 0;
            const sanity = data.sanity ?? 0;
            const stress = data.stress ?? 0;
            const isPaused = data.isPaused ?? false;

            // Generate HTML Row
            html += `
                <tr>
                    <td><span class="status-text">${id}</span></td>
                    <td>${renderBar(hp, maxhp, '')}</td>
                    <td>
                        ${renderBar(waterTime, MAX_TIME, 'water-fill')}
                        <span class="timer-text">${formatTime(waterTime)}</span>
                    </td>
                    <td>
                        ${renderBar(foodTime, MAX_TIME, 'food-fill')}
                        <span class="timer-text">${formatTime(foodTime)}</span>
                    </td>
                    <td>${renderBar(sanity, 100, 'sanity-fill')}</td>
                    <td>${renderBar(stress, 200, 'stress-fill')}</td>
                    <td>${isPaused ? '<span class="paused">‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤</span>' : '<span class="running">‚ñ∂Ô∏è ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</span>'}</td>
                </tr>
            `;
        });
        
        // Update the entire table body
        if (html === '') {
            dashboardBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</td></tr>`;
        } else {
            dashboardBody.innerHTML = html;
        }

        document.getElementById('status').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${querySnapshot.size} ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£)`;
    }, (error) => {
        console.error("Listener error:", error);
        document.getElementById('status').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤!`;
    });
}
</script>
</body>
</html>